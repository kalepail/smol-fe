---
import { ClientRouter } from 'astro:transitions';
import Header from '../components/Header.svelte'
import MixtapeBuilderOverlay from '../components/mixtape/MixtapeBuilderOverlay.svelte'
import BarAudioPlayer from '../components/audio/BarAudioPlayer.svelte'
import GlobalVerification from '../components/GlobalVerification.svelte'
import OnboardingGuard from '../components/onboarding/OnboardingGuard.svelte'
import PasskeyReprompt from '../components/retention/PasskeyReprompt.svelte'
import DynamicBackground from '../components/layout/DynamicBackground.svelte'
import '../styles/global.css'

interface Props {
	title?: string;
	description?: string;
	song_url?: string | null;
	image_url?: string | null;
	hideBottomBar?: boolean;
}

const {
	title,
	description = "Smol art onchain",
	song_url = "https://cdn2.aisonggenerator.io/491bb94b-79df-41bb-b09b-2d295f1dfd05.mp3",
	image_url,
	hideBottomBar = false,
} = Astro.props;

let _kid = null
let _cid = null

const token = Astro.cookies.get('smol_token')?.value?.split('.')?.[1];

if (token) {
	const { sub, key } = JSON.parse(atob(token));

	_kid = key;
	_cid = sub;
}



---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="robots" content="index, follow" />
		<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
		<link rel="apple-touch-icon" href={image_url ? image_url : "https://noot.smol.xyz/favicon.png"} />
		<link rel="icon" type="image/png" href={image_url ? image_url : "https://noot.smol.xyz/favicon.png"} />
		<meta name="generator" content={Astro.generator} />
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="color-scheme" content="dark">
		<meta name="theme-color" content="#020617">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta name="apple-mobile-web-app-title" content={title}>
		<link rel="manifest" href="/manifest.json">
		<ClientRouter />

		<title transition:animate="fade">{title}</title>
		<meta name="description" content={description}>
		<!-- <meta name="medium" content="audio"> -->
		<link rel="canonical" href={Astro.url}>

		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:type" content="music.song" />
		<meta property="og:url" content={Astro.url} />
		<meta property="og:image" content={image_url ? `${image_url}?scale=16` : "https://noot.smol.xyz/meta.png"} />
		<!-- <meta property="og:image:width" content="1024">
		<meta property="og:image:height" content="1024"> -->
		<!-- <meta property="og:image:type" content="image/png"> -->
		<meta property="og:audio" content={song_url} />
		<meta property="og:audio:secure_url" content={song_url} />
		<meta property="og:audio:type" content="audio/mpeg" />

		<!-- <link rel="alternate" type="application/json+oembed" href="//embed//"> -->

		<!-- <meta property="og:video" content="">
		<meta property="og:video:secure_url" content="">
		<meta property="og:video:type" content="video/mp4">
		<meta property="og:video:width" content="1024">
		<meta property="og:video:height" content="1024">
		<meta property="og:type" content="video.other"> -->

		<meta name="twitter:card" content={song_url ? "player" : "summary_large_image"} />
		<!-- <meta name="twitter:site" content="@smolxyz"> -->
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={image_url ? `${image_url}?scale=16` : "https://noot.smol.xyz/meta.png"} />
		<meta name="twitter:url" content={Astro.url} />
		
		{song_url && (
			<>
				<meta name="twitter:player" content={song_url} />
				<meta name="twitter:player:width" content="500" />
				<meta name="twitter:player:height" content="80" />
			</>
		)}
		<style is:global>
			/* Nuclear CSS option: globally hide SmolResults loading cards */
			[data-smol-loading] {
				display: none !important;
				visibility: hidden !important;
				opacity: 0 !important;
				pointer-events: none !important;
			}

			/* Hide scrollbars globally but keep functionality */
			::-webkit-scrollbar {
				display: none;
			}
			* {
				scrollbar-width: none;  /* Firefox */
				-ms-overflow-style: none;  /* IE and Edge */
			}
		</style>
	</head>
	<body class="bg-transparent text-white min-h-screen relative">
		<script is:inline>
			// Nuclear option: destroy SmolResults loading cards immediately and on all events
			function destroyLoadingCards() {
				const loadingCards = document.querySelectorAll('[data-smol-loading]');
				loadingCards.forEach(card => {
					card.style.display = 'none';
					card.remove();
				});
			}

			// Run immediately
			destroyLoadingCards();

			// Run on DOMContentLoaded
			document.addEventListener('DOMContentLoaded', destroyLoadingCards);

			// Run on Astro page load
			document.addEventListener('astro:page-load', destroyLoadingCards);

			// Run on Astro before swap
			document.addEventListener('astro:before-swap', destroyLoadingCards);

			// Run on Astro after swap
			document.addEventListener('astro:after-swap', destroyLoadingCards);

			// Observe for any new loading cards being added
			const observer = new MutationObserver(destroyLoadingCards);
			observer.observe(document.body || document.documentElement, {
				childList: true,
				subtree: true
			});
		</script>
		<!-- Global Dynamic Background (Pixel Kale Field) -->
		<DynamicBackground 
			client:only="svelte" 
			disableWeather={Astro.url.pathname.startsWith('/mixtapes') || Astro.url.pathname.startsWith('/kale')} 
			hidden={Astro.url.pathname.startsWith('/kale')}
		/>

		<Header _kid={_kid} _cid={_cid} client:load transition:persist="header" />
		<GlobalVerification client:only="svelte" />
		<OnboardingGuard client:only="svelte" isAuthenticatedServer={!!_cid} />
		<PasskeyReprompt client:load />
		
		<BarAudioPlayer client:only="svelte" transition:persist="audio-player" hideBottomBar={hideBottomBar} />

		<MixtapeBuilderOverlay client:load transition:persist="mixtape-builder" />
		<slot />
	</body>
</html>
