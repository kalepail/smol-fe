---
import Layout from '../../layouts/Layout.astro';
import snapshot from '../../data/smols-snapshot.json';
import ArtistResults from '../../components/artist/ArtistResults.svelte';

export function getStaticPaths() {
  const addresses = new Set();
  snapshot.forEach(smol => {
    if (smol.Address) addresses.add(smol.Address);
  });
  
  return Array.from(addresses).map(addr => ({ params: { address: addr } }));
}

const { address } = Astro.params;

// Discography: Songs created or published by this artist
const discographySmols = snapshot.filter(s => 
  s.Address === address || s.Creator === address
);
discographySmols.sort((a, b) => new Date(b.Created_At).getTime() - new Date(a.Created_At).getTime());

// Minted: Created by them AND has been minted (by anyone)
const mintedSmols = discographySmols.filter(s => s.Mint_Token !== null);

// Collected: Minted by this artist but NOT created by them
const collectedSmols = snapshot.filter(s => 
  s.Minted_By === address && 
  s.Address !== address && 
  s.Creator !== address
);
collectedSmols.sort((a, b) => new Date(b.Created_At).getTime() - new Date(a.Created_At).getTime());

const publishedCount = discographySmols.length;
const collectedCount = collectedSmols.length;
const mintedCount = mintedSmols.length;

// Top Tags (from Discography)
const tagCounts = {};
discographySmols.forEach(smol => {
    if (smol.Tags && Array.isArray(smol.Tags)) {
        smol.Tags.forEach(tag => {
            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
        });
    }
});
const topTags = Object.entries(tagCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 4)
    .map(t => t[0]);
---

<Layout title={`Artist ${address.substring(0, 6)}...`}>
	<main class="min-h-screen bg-[#0d0d0d] text-white p-4 pt-4 md:pt-8 max-w-7xl mx-auto flex flex-col justify-center">
        <ArtistResults 
            client:load 
            discography={discographySmols} 
            minted={mintedSmols} 
            collected={collectedSmols}
            address={address} 
            publishedCount={publishedCount}
            collectedCount={collectedCount}
            mintedCount={mintedCount}
            topTags={topTags}
        />
	</main>
</Layout>
