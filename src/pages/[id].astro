---
import SmolResults from "../components/smol/SmolResults.svelte";
import Layout from "../layouts/Layout.astro";

const { id } = Astro.params;

// Fetch minimal data for SEO/meta tags only
let title: string | undefined;
let description: string | undefined;
let song_url: string | null = null;
let image_url: string | null = id ? `${import.meta.env.PUBLIC_API_URL}/image/${id}.png` : null;

if (id) {
	try {
		const data = await fetch(`${import.meta.env.PUBLIC_API_URL}/${id}`, {
			headers: {
				Cookie: Astro.request.headers.get("cookie") ?? "",
			},
		}).then(async (res) => {
			if (res.ok) return res.json();
			return null;
		});

		if (data) {
			title = data.kv_do?.lyrics?.title || data.d1?.Title;
			description = data.kv_do?.payload?.prompt || data.kv_do?.description;

			// Set song URL
			if (data.d1?.Song_1) {
				song_url = `${import.meta.env.PUBLIC_API_URL}/song/${data.d1.Song_1}.mp3`;
			} else if (data.kv_do?.songs?.[0]?.audio) {
				song_url = `${import.meta.env.PUBLIC_API_URL}/song/${data.kv_do.songs[0].music_id}.mp3`;
			}
		}
	} catch (error) {
		console.error('Failed to fetch meta data:', error);
	}
}
---

<Layout {title} {description} {song_url} {image_url}>
	<div class="h-screen flex items-center justify-center -mt-16">
		<SmolResults id={id as string} client:only="svelte" />
	</div>
</Layout>
